name: Full Auto Boat Race 2025

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # 1. データ収集（20分割：待機ゼロで全機同時発進）
  collect:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 20 # 20台フル稼働
      matrix:
        include:
          # 1. 01/01 - 01/19 (19日間)
          - { s: "2025-01-01", e: "2025-01-19" }
          # 2. 01/20 - 02/07 (19日間)
          - { s: "2025-01-20", e: "2025-02-07" }
          # 3. 02/08 - 02/26 (19日間)
          - { s: "2025-02-08", e: "2025-02-26" }
          # 4. 02/27 - 03/16 (18日間) ※2月は28日まで
          - { s: "2025-02-27", e: "2025-03-16" }
          # 5. 03/17 - 04/03 (18日間)
          - { s: "2025-03-17", e: "2025-04-03" }
          # 6. 04/04 - 04/21 (18日間)
          - { s: "2025-04-04", e: "2025-04-21" }
          # 7. 04/22 - 05/09 (18日間)
          - { s: "2025-04-22", e: "2025-05-09" }
          # 8. 05/10 - 05/27 (18日間)
          - { s: "2025-05-10", e: "2025-05-27" }
          # 9. 05/28 - 06/14 (18日間)
          - { s: "2025-05-28", e: "2025-06-14" }
          # 10. 06/15 - 07/02 (18日間)
          - { s: "2025-06-15", e: "2025-07-02" }
          # 11. 07/03 - 07/20 (18日間)
          - { s: "2025-07-03", e: "2025-07-20" }
          # 12. 07/21 - 08/07 (18日間)
          - { s: "2025-07-21", e: "2025-08-07" }
          # 13. 08/08 - 08/25 (18日間)
          - { s: "2025-08-08", e: "2025-08-25" }
          # 14. 08/26 - 09/12 (18日間)
          - { s: "2025-08-26", e: "2025-09-12" }
          # 15. 09/13 - 09/30 (18日間)
          - { s: "2025-09-13", e: "2025-09-30" }
          # 16. 10/01 - 10/18 (18日間)
          - { s: "2025-10-01", e: "2025-10-18" }
          # 17. 10/19 - 11/05 (18日間)
          - { s: "2025-10-19", e: "2025-11-05" }
          # 18. 11/06 - 11/23 (18日間)
          - { s: "2025-11-06", e: "2025-11-23" }
          # 19. 11/24 - 12/11 (18日間)
          - { s: "2025-11-24", e: "2025-12-11" }
          # 20. 12/12 - 12/31 (20日間)
          - { s: "2025-12-12", e: "2025-12-31" }

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install pandas requests beautifulsoup4
      
      - name: Scrape
        run: python collector.py --start ${{ matrix.s }} --end ${{ matrix.e }}
        
      - name: Upload Chunk
        uses: actions/upload-artifact@v4
        with:
          name: chunk-${{ matrix.s }}
          path: data/*.csv
          retention-days: 1

  # 2. 自動結合＆コミット
  merge_and_push:
    needs: collect
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install pandas

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_data
          pattern: chunk-*
          merge-multiple: true

      - name: Merge CSVs
        shell: python
        run: |
          import pandas as pd
          import glob
          import os
          
          files = glob.glob("all_data/*.csv")
          print(f"Found {len(files)} CSV files.")
          
          if files:
              df_list = [pd.read_csv(f) for f in files]
              master_df = pd.concat(df_list, ignore_index=True)
              master_df = master_df.sort_values(by=['date', 'jcd', 'rno'])
              
              output_file = "FINAL_BOAT_DATA_2025.csv"
              master_df.to_csv(output_file, index=False)
              print(f"Successfully created {output_file} with {len(master_df)} rows.")
          else:
              print("No CSV files found. Skipping merge.")

      - name: Commit & Push
        run: |
          git config --global user.name "BoatBot"
          git config --global user.email "bot@example.com"
          git add FINAL_BOAT_DATA_2025.csv
          git commit -m "Update full 2025 dataset" || echo "No changes to commit"
          git push
