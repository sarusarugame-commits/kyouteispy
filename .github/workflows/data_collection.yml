name: 20x Parallel Auto Loop

on:
  workflow_dispatch:
    inputs:
      target_year:
        description: 'é–‹å§‹ã™ã‚‹å¹´ (ä¾‹: 2023)'
        required: true
        default: '2023'
      end_year:
        description: 'çµ‚äº†ã™ã‚‹å¹´ (ä¾‹: 2024)'
        required: true
        default: '2024'

permissions:
  contents: write
  actions: write

jobs:
  # ========================================================
  # 1. 20ä¸¦åˆ—åé›† (ã“ã“ã§ã®é€šçŸ¥ã¯ãªã—)
  # ========================================================
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix:
        include:
          - { s: "01-01", e: "01-18" }
          - { s: "01-19", e: "02-05" }
          - { s: "02-06", e: "02-24" }
          - { s: "02-25", e: "03-14" }
          - { s: "03-15", e: "04-01" }
          - { s: "04-02", e: "04-20" }
          - { s: "04-21", e: "05-08" }
          - { s: "05-09", e: "05-27" }
          - { s: "05-28", e: "06-14" }
          - { s: "06-15", e: "07-02" }
          - { s: "07-03", e: "07-21" }
          - { s: "07-22", e: "08-09" }
          - { s: "08-10", e: "08-27" }
          - { s: "08-28", e: "09-14" }
          - { s: "09-15", e: "10-02" }
          - { s: "10-03", e: "10-21" }
          - { s: "10-22", e: "11-08" }
          - { s: "11-09", e: "11-26" }
          - { s: "11-27", e: "12-14" }
          - { s: "12-15", e: "12-31" }

    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # cache: 'pip' ã‚’å‰Šé™¤ (ã“ã‚ŒãŒã‚¨ãƒ©ãƒ¼åŸå› ã ã£ãŸ)
          
      - run: pip install pandas requests beautifulsoup4

      - name: Run Collector (${{ inputs.target_year }}-${{ matrix.s }} ~ ${{ matrix.e }})
        run: |
          YEAR="${{ inputs.target_year }}"
          START="$YEAR-${{ matrix.s }}"
          END="$YEAR-${{ matrix.e }}"
          echo "ğŸš€ Running: $START to $END"
          # Discordé€šçŸ¥ã®ç’°å¢ƒå¤‰æ•°ã¯å‰Šé™¤(Pythonå´ã§é€ã‚‰ãªã„ãŸã‚)
          python collector.py --start $START --end $END

      - uses: actions/upload-artifact@v4
        with:
          name: chunk-${{ matrix.s }}
          path: data/*.csv
          retention-days: 1

  # ========================================================
  # 2. çµåˆãƒ»ä¿å­˜ãƒ»é€šçŸ¥ãƒ»å†èµ·å‹•
  # ========================================================
  merge:
    needs: collect
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install pandas requests

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_data
          pattern: chunk-*
          merge-multiple: true

      - name: Merge and Save
        id: merge_step
        run: |
          python -c "
          import pandas as pd
          import glob
          import os
          
          files = glob.glob('all_data/*.csv')
          if not files:
              print('No data found!')
              exit(0)
              
          print(f'Merging {len(files)} files...')
          df_list = []
          for f in files:
              try:
                  tmp = pd.read_csv(f)
                  if not tmp.empty: df_list.append(tmp)
              except: pass
          
          if df_list:
              df = pd.concat(df_list, ignore_index=True)
              df['date'] = df['date'].astype(int)
              df = df.sort_values(['date', 'jcd', 'rno'])
              
              filename = 'FINAL_FULL_DATA_${{ inputs.target_year }}.csv'
              df.to_csv(filename, index=False)
              print(f'Saved {filename} with {len(df)} rows.')
          "

      - name: Push to Git
        run: |
          git config --global user.name "BoatBot"
          git config --global user.email "bot@example.com"
          git pull origin main --rebase || true
          git add FINAL_FULL_DATA_*.csv
          git commit -m "Add Data ${{ inputs.target_year }}" || echo "No changes"
          git push origin main

      # ğŸ”¥ ã“ã“ã§é€šçŸ¥ (1å¹´åˆ†çµ‚ã‚ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°) ğŸ”¥
      - name: Notify Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          TARGET_YEAR: ${{ inputs.target_year }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{\"content\": \"âœ… **${TARGET_YEAR}å¹´ã®åé›†ãƒ»çµåˆãŒå®Œäº†ã—ã¾ã—ãŸï¼**\næ¬¡ã®å¹´ã®å‡¦ç†ãŒã‚ã‚Œã°é–‹å§‹ã—ã¾ã™ã€‚\"}" \
                 $DISCORD_WEBHOOK_URL
          fi

      # ğŸ”¥ è‡ªå‹•ãƒ«ãƒ¼ãƒ—æ©Ÿèƒ½ (æ¬¡ã®å¹´ã¸) ğŸ”¥
      - name: Trigger Next Year
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT=${{ inputs.target_year }}
          END=${{ inputs.end_year }}
          NEXT=$((CURRENT + 1))

          if [ "$NEXT" -le "$END" ]; then
            echo "ğŸ”„ $CURRENTå¹´å®Œäº†ï¼æ¬¡ã¯ $NEXTå¹´ ã‚’é–‹å§‹ã—ã¾ã™..."
            gh workflow run 20_parallel_auto.yml -f target_year=$NEXT -f end_year=$END
          else
            echo "ğŸ‰ å…¨æŒ‡å®šæœŸé–“ ($ENDå¹´ã¾ã§) ã®åé›†ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
            # å…¨ã¦çµ‚ã‚ã£ãŸæ™‚ã®é€šçŸ¥
            if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
               curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{\"content\": \"ğŸ‰ **å…¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‡ãƒ¼ã‚¿åé›†ãŒå®Œå…¨ã«çµ‚äº†ã—ã¾ã—ãŸï¼**\"}" \
                 ${{ secrets.DISCORD_WEBHOOK_URL }}
            fi
          fi
