name: Debug One Day (Final Check)

on:
  workflow_dispatch: # 手動実行ボタン

jobs:
  debug_collect:
    runs-on: ubuntu-latest
    
    steps:
      - name: コード取得
        uses: actions/checkout@v4

      - name: Python準備
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ライブラリ導入
        run: pip install pandas requests beautifulsoup4

      - name: 1日分デバッグ実行
        # -u をつけてログを即時表示
        # 1月1日だけを指定して実行します
        run: python -u collector.py --start 2025-01-01 --end 2025-01-01

      - name: 成果物アップロード
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: debug-data-final
          path: data/*.csv

      - name: Discord通知
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            MSG="✅ **デバッグ成功**\n風速エラーは解消されました！CSVを確認してください。"
          else
            MSG="❌ **デバッグ失敗**\nまだエラーがあります。ログを確認してください。"
          fi
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"username\": \"Debug_Bot\", \"content\": \"$MSG\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
