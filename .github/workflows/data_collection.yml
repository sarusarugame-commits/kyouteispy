name: Boat Race Debug Collector

on:
  workflow_dispatch: # 手動で実行

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install
        run: pip install pandas requests beautifulsoup4

      - name: Run Collector
        # デバッグとして2025年1月1日の1日分だけを実行
        run: python collector.py --start 2025-01-01 --end 2025-01-01

      - name: Discord Notification
        if: always() # 成功・失敗に関わらず通知
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            MSG="✅ **データ収集成功**\n1日分の純粋データ収集が完了しました。"
          else
            MSG="⚠️ **データ収集失敗**\nエラーが発生しました。ログを確認してください。"
          fi
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"username\": \"Sniper_Collector\", \"content\": \"$MSG\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Upload CSV
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: debug-data
          path: data/*.csv
