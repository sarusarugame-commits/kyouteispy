name: 20x Parallel Auto Loop

on:
  workflow_dispatch:
    inputs:
      target_year:
        description: 'é–‹å§‹ã™ã‚‹å¹´ (ä¾‹: 2023)'
        required: true
        default: '2023'
      end_year:
        description: 'çµ‚äº†ã™ã‚‹å¹´ (ä¾‹: 2024)'
        required: true
        default: '2025'

permissions:
  contents: write
  actions: write

jobs:
  # ========================================================
  # 1. 20ä¸¦åˆ—ã§ãƒ‡ãƒ¼ã‚¿åé›†
  # ========================================================
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false  # 1ã¤ã®æœŸé–“ãŒå¤±æ•—ã—ã¦ã‚‚ä»–ã¯ç¶šè¡Œã•ã›ã‚‹
      max-parallel: 20
      matrix:
        # 1å¹´(365æ—¥) Ã· 20 â‰ˆ 18æ—¥/ã‚¹ãƒ¬ãƒƒãƒ‰
        include:
          - { s: "01-01", e: "01-18" }
          - { s: "01-19", e: "02-05" }
          - { s: "02-06", e: "02-24" }
          - { s: "02-25", e: "03-14" } # é–å¹´ã‚‚ã“ã®åŒºé–“ã«å«ã¾ã‚Œã‚‹ã®ã§OK
          - { s: "03-15", e: "04-01" }
          - { s: "04-02", e: "04-20" }
          - { s: "04-21", e: "05-08" }
          - { s: "05-09", e: "05-27" }
          - { s: "05-28", e: "06-14" }
          - { s: "06-15", e: "07-02" }
          - { s: "07-03", e: "07-21" }
          - { s: "07-22", e: "08-09" }
          - { s: "08-10", e: "08-27" }
          - { s: "08-28", e: "09-14" }
          - { s: "09-15", e: "10-02" }
          - { s: "10-03", e: "10-21" }
          - { s: "10-22", e: "11-08" }
          - { s: "11-09", e: "11-26" }
          - { s: "11-27", e: "12-14" }
          - { s: "12-15", e: "12-31" }

    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - run: pip install pandas requests beautifulsoup4

      - name: Run Collector (${{ inputs.target_year }}-${{ matrix.s }} ~ ${{ matrix.e }})
        run: |
          YEAR="${{ inputs.target_year }}"
          START="$YEAR-${{ matrix.s }}"
          END="$YEAR-${{ matrix.e }}"
          echo "ğŸš€ Running: $START to $END"
          # å‰è¿°ã®Pythonã‚³ãƒ¼ãƒ‰ãŒ 'collector.py' ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å‰æ
          python collector.py --start $START --end $END

      - uses: actions/upload-artifact@v4
        with:
          # åå‰ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã™ã‚‹
          name: chunk-${{ matrix.s }}
          path: data/*.csv
          retention-days: 1

  # ========================================================
  # 2. çµåˆãƒ»ä¿å­˜ãƒ»é€šçŸ¥ãƒ»æ¬¡å¹´åº¦ãƒˆãƒªã‚¬ãƒ¼
  # ========================================================
  merge:
    needs: collect
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install pandas requests

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_data
          pattern: chunk-*
          merge-multiple: true

      - name: Merge and Save
        run: |
          python -c "
          import pandas as pd
          import glob
          import os
          import sys

          # å†å¸°çš„ã«æ¤œç´¢ã—ã¦ãƒ‘ã‚¹ã®é•ã„ã‚’å¸å
          files = glob.glob('all_data/**/*.csv', recursive=True)
          if not files:
              print('âŒ No data found!')
              sys.exit(0) # ã‚¨ãƒ©ãƒ¼ã«ã¯ã›ãšçµ‚äº†
              
          print(f'Merging {len(files)} files...')
          df_list = []
          for f in files:
              try:
                  # å„ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã§ãã®ã¾ã¾èª­ã‚€
                  tmp = pd.read_csv(f)
                  if not tmp.empty: 
                      df_list.append(tmp)
              except Exception as e:
                  print(f'Skipping {f}: {e}')
          
          if df_list:
              df = pd.concat(df_list, ignore_index=True)
              # æ—¥ä»˜ãƒ»å ´ãƒ»ãƒ¬ãƒ¼ã‚¹ã§ã‚½ãƒ¼ãƒˆ
              if 'date' in df.columns:
                  df['date'] = df['date'].astype(int)
                  df = df.sort_values(['date', 'jcd', 'rno'])
              
              filename = 'FINAL_FULL_DATA_${{ inputs.target_year }}.csv'
              df.to_csv(filename, index=False)
              print(f'âœ… Saved {filename} with {len(df)} rows.')
          else:
              print('âš ï¸ Valid dataframe is empty.')
          "

      - name: Push to Git
        run: |
          git config --global user.name "BoatBot"
          git config --global user.email "bot@example.com"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯addã—ãªã„ã‚ˆã†ã«åˆ¶å¾¡
          if ls FINAL_FULL_DATA_*.csv 1> /dev/null 2>&1; then
            git add FINAL_FULL_DATA_*.csv
            git commit -m "Add Data ${{ inputs.target_year }}" || echo "No changes to commit"
            
            # ãƒªãƒ™ãƒ¼ã‚¹ãƒ—ãƒ«ã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
            git pull origin main --rebase
            git push origin main
          else
            echo "No CSV file generated to push."
          fi

      - name: Notify Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          TARGET_YEAR: ${{ inputs.target_year }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{\"content\": \"âœ… **${TARGET_YEAR}å¹´ã®åé›†ãŒå®Œäº†ã—ã¾ã—ãŸï¼**\"}" \
                 $DISCORD_WEBHOOK_URL
          fi

      - name: Trigger Next Year
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT=${{ inputs.target_year }}
          END=${{ inputs.end_year }}
          NEXT=$((CURRENT + 1))

          if [ "$NEXT" -le "$END" ]; then
            echo "ğŸ”„ $CURRENTå¹´å®Œäº†ï¼æ¬¡ã¯ $NEXTå¹´ ã‚’é–‹å§‹ã—ã¾ã™..."
            # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ(ref)ã‚’å¼•ãç¶™ã„ã§å®Ÿè¡Œã™ã‚‹
            gh workflow run "20x Parallel Auto Loop" \
              --ref ${{ github.ref_name }} \
              -f target_year=$NEXT \
              -f end_year=$END
          else
            echo "ğŸ‰ å…¨æŒ‡å®šæœŸé–“ ($ENDå¹´ã¾ã§) ã®åé›†ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
            if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
               curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{\"content\": \"ğŸ‰ **å…¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‡ãƒ¼ã‚¿åé›†ãŒå®Œå…¨ã«çµ‚äº†ã—ã¾ã—ãŸï¼**\"}" \
                 ${{ secrets.DISCORD_WEBHOOK_URL }}
            fi
          fi
