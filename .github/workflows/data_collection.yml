name: Debug Data Collector

on:
  workflow_dispatch: # GitHubのActionsタブから手動で実行

jobs:
  debug_collect:
    runs-on: ubuntu-latest
    
    steps:
      - name: コードをチェックアウト
        uses: actions/checkout@v4

      - name: Pythonをセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 依存ライブラリをインストール
        run: |
          pip install pandas requests beautifulsoup4

      - name: デバッグ収集を実行
        id: run_script
        run: python debug_collector.py

      - name: 成功通知をDiscordに送信
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"username\": \"Sniper_Debug_Bot\", \"content\": \"✅ **データ収集完了**\n1日分のデバッグスクレイピングが正常に終了しました。CSVを確認してください。\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: 失敗通知をDiscordに送信
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"username\": \"Sniper_Debug_Bot\", \"content\": \"⚠️ **データ収集エラー**\nスクレイピング実行中に問題が発生しました。GitHubのログを確認してください。\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: 取得したCSVを保存 (Artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-csv-data
          path: debug_data_*.csv
