name: Boat Race Debug Collector

on:
  workflow_dispatch: # 手動実行用ボタン

jobs:
  collect:
    runs-on: ubuntu-latest
    
    steps:
      - name: コードのチェックアウト
        uses: actions/checkout@v4

      - name: Pythonのセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ライブラリのインストール
        run: |
          pip install pandas requests beautifulsoup4

      - name: データ収集の実行
        # python -u を使うことでログをリアルタイムに表示させます
        run: python -u collector.py --start 2025-01-01 --end 2025-01-01

      - name: Discord通知 (成否判定)
        if: always() # 途中で止まっても必ず実行
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            MSG="✅ **データ収集成功**\nログを確認し、CSVが生成されたことを確認してください。"
          else
            MSG="⚠️ **データ収集失敗**\nエラーが発生しました。ログの詳細を確認してください。"
          fi
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"username\": \"Sniper_Collector\", \"content\": \"$MSG\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: 成果物のアップロード
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: debug-data
          path: data/*.csv
